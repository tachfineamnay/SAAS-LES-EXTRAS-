generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENT
  TALENT
  ADMIN
}

enum UserStatus {
  PENDING
  VERIFIED
  BANNED
}

enum ReliefMissionStatus {
  OPEN
  ASSIGNED
  COMPLETED
  CANCELLED
}

enum ServiceType {
  WORKSHOP
  TRAINING
}



model User {
  id             String          @id @default(cuid())
  email          String          @unique
  password       String
  role           UserRole
  status         UserStatus      @default(PENDING)
  onboardingStep Int             @default(0)
  isAvailable    Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  profile        Profile?
  clientMissions ReliefMission[] @relation("ClientMissions")
  ownerServices  Service[]       @relation("OwnerServices")
  clientBookings Booking[]       @relation("ClientBookings")
  talentBookings Booking[]       @relation("TalentBookings")
  freelanceQuotes Quote[]         @relation("FreelanceQuotes")
  establishmentQuotes Quote[]     @relation("EstablishmentQuotes")
  sentMessages     DirectMessage[] @relation("SentMessages")
  receivedMessages DirectMessage[] @relation("ReceivedMessages")
  notifications    Notification[]
  packPurchases    PackPurchase[]
}

model DirectMessage {
  id        String   @id @default(cuid())
  content   String
  senderId  String
  receiverId String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  sender    User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver  User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
}

model Profile {
  id             String   @id @default(cuid())
  userId         String   @unique
  firstName      String
  lastName       String
  bio            String?
  avatar         String?
  jobTitle       String?
  phone          String?
  address        String?
  city           String?
  zipCode        String?
  country        String?
  skills         String[]
  companyName    String?
  siret          String?
  tvaNumber      String?
  onboardingStep Int      @default(0)
  availableCredits Int    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  message   String
  type      String   // INFO, SUCCESS, WARNING
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PackPurchase {
  id           String   @id @default(cuid())
  clientId     String
  amount       Float
  creditsAdded Int
  createdAt    DateTime @default(now())
  client       User     @relation(fields: [clientId], references: [id])
}

model ReliefMission {
  id        String             @id @default(cuid())
  title     String
  dateStart DateTime
  dateEnd   DateTime
  hourlyRate  Float
  status    ReliefMissionStatus @default(OPEN)
  isRenfort Boolean            @default(false)
  address   String
  clientId  String
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  client    User               @relation("ClientMissions", fields: [clientId], references: [id], onDelete: Restrict)
  bookings  Booking[]
  quotes    Quote[]

  @@index([clientId])
}

model Service {
  id          String      @id @default(cuid())
  title       String
  description String?
  price       Float
  type        ServiceType
  capacity    Int
  isFeatured  Boolean     @default(false)
  isHidden    Boolean     @default(false)
  ownerId     String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  owner       User        @relation("OwnerServices", fields: [ownerId], references: [id], onDelete: Restrict)
  bookings    Booking[]

  @@index([ownerId])
}

enum QuoteStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model Quote {
  id              String         @id @default(cuid())
  amount          Float
  description     String
  startDate       DateTime
  endDate         DateTime
  status          QuoteStatus    @default(PENDING)
  freelanceId     String
  establishmentId String
  reliefMissionId String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  freelance       User           @relation("FreelanceQuotes", fields: [freelanceId], references: [id])
  establishment   User           @relation("EstablishmentQuotes", fields: [establishmentId], references: [id])
  reliefMission   ReliefMission? @relation(fields: [reliefMissionId], references: [id])
  booking         Booking?
}

enum BookingStatus {
  PENDING
  CONFIRMED
  PAID
  COMPLETED
  COMPLETED_AWAITING_PAYMENT
  CANCELLED
}

// ... existing models ...

model Booking {
  id              String        @id @default(cuid())
  status          BookingStatus @default(PENDING)
  message         String?
  scheduledAt     DateTime      @default(now())
  clientId        String
  talentId        String?
  reliefMissionId String?
  serviceId       String?
  quoteId         String?       @unique
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  client          User          @relation("ClientBookings", fields: [clientId], references: [id], onDelete: Restrict)
  talent          User?         @relation("TalentBookings", fields: [talentId], references: [id], onDelete: SetNull)
  reliefMission   ReliefMission? @relation(fields: [reliefMissionId], references: [id], onDelete: SetNull)
  service         Service?      @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  quote           Quote?        @relation(fields: [quoteId], references: [id])
  invoice         Invoice?

  @@index([clientId])
  @@index([talentId])
  @@index([reliefMissionId])
  @@index([serviceId])
}

enum InvoiceStatus {
  PENDING_PAYMENT
  PAID
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String?       @unique // Optional initially to allow backfill if needed, or default null
  status        InvoiceStatus @default(PENDING_PAYMENT)
  url           String
  amount        Float
  commissionAmount Float        @default(0)
  bookingId     String        @unique
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  booking       Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}
